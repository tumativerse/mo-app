# Clerk Webhook Setup

## What This Does

**Automatically creates users in our database when they sign up in Clerk.**

- User clicks "Sign In" or "Sign Up" → either works!
- Clerk handles authentication
- Webhook fires → creates user in our database
- User sees lock screen → completes profile
- No manual coordination needed ✅

---

## Setup Instructions

### Step 1: Get Webhook Signing Secret

1. **Go to Clerk Dashboard:** https://dashboard.clerk.com
2. **Select:** "Tumati Apps" application → Production instance
3. **Go to:** Configure → Webhooks
4. **Click:** "Add Endpoint"

5. **Configure endpoint:**
   - **Endpoint URL:** `https://mo.tumati.me/api/webhooks/clerk`
   - **Subscribe to events:**
     - ✅ `user.created`
     - ✅ `user.updated`
     - ✅ `user.deleted`
   - **Click:** "Create"

6. **Copy the Signing Secret:**
   - After creating, you'll see a "Signing Secret"
   - It starts with `whsec_...`
   - **Copy this value**

### Step 2: Add Secret to Vercel

Run this command:

```bash
vercel env add CLERK_WEBHOOK_SECRET production
# Paste the signing secret when prompted (whsec_...)
```

### Step 3: Deploy

```bash
git add -A
git commit -m "Add Clerk webhook handler"
git push
vercel --prod
```

### Step 4: Test the Webhook

1. **Go to Clerk Dashboard → Webhooks**
2. **Click on your webhook endpoint**
3. **Click "Testing" tab**
4. **Click "Send Test Event"** → Select `user.created`
5. **Check response:** Should return `200 OK` and `{"success": true}`

---

## How It Works

```
┌─────────────┐
│   User      │
│ Signs Up    │
└─────┬───────┘
      │
      ▼
┌─────────────────┐
│   Clerk Auth    │  ← Handles authentication
└─────┬───────────┘
      │
      │ Fires webhook
      ▼
┌──────────────────────┐
│ /api/webhooks/clerk  │  ← Our handler
│                      │
│ 1. Verify signature  │
│ 2. Create user in DB │
│ 3. Create preferences│
└──────┬───────────────┘
       │
       ▼
┌──────────────────┐
│  Database        │
│  ✅ User created │
│  ✅ Preferences  │
└──────────────────┘
```

---

## Events Handled

### `user.created`

- **When:** User signs up for the first time
- **What we do:**
  - Create user record in `users` table
  - Create default preferences in `user_preferences` table
  - User will see lock screen on first login

### `user.updated`

- **When:** User updates their email in Clerk
- **What we do:**
  - Update email in our database
  - Keep user data in sync

### `user.deleted`

- **When:** User deletes their account in Clerk
- **What we do:**
  - Log the deletion (currently just logs)
  - **Optional:** Delete all user data from our database

---

## Environment Variables

**Required:**

```bash
CLERK_WEBHOOK_SECRET=whsec_... # From Clerk Dashboard → Webhooks
```

**Already configured:**

```bash
NEXT_PUBLIC_CLERK_PUBLISHABLE_KEY=pk_live_...
CLERK_SECRET_KEY=sk_live_...
```

---

## Security

- ✅ Webhook signature verification using `svix`
- ✅ Only Clerk can call this endpoint (signature required)
- ✅ Public route in middleware (doesn't require authentication)
- ✅ Idempotent (safe to retry - checks if user exists)

---

## Testing

### Test webhook locally with Clerk CLI:

```bash
# Install Clerk CLI
npm install -g @clerk/clerk-sdk-node

# Forward webhooks to localhost
clerk webhooks forward --endpoint /api/webhooks/clerk
```

### Manual test:

```bash
# Sign up a new user in your app
# Check logs:
vercel logs mo.tumati.me --since 5m | grep "Webhook"

# Should see:
# Webhook received: user.created for user user_xxx
# Creating user: user_xxx (email@example.com)
# Created user in DB: abc123
# Created default preferences for user: abc123
```

---

## Troubleshooting

### Webhook fails with 400/401

- Check CLERK_WEBHOOK_SECRET is set correctly
- Verify signing secret matches Clerk Dashboard

### User not created in database

- Check webhook logs in Vercel
- Verify DATABASE_URL is correct
- Check Clerk Dashboard → Webhooks → Attempts (shows all webhook deliveries)

### Duplicate user errors

- The webhook handler checks if user exists before creating
- Safe to retry

---

## Future Apps

When you add a new app (e.g., taskflow.tumati.me):

1. **Same webhook works for all apps!**
2. **Use same Clerk keys** (from "Tumati Apps")
3. **Users automatically created** when they sign up
4. **No additional configuration needed**

The webhook URL can stay `mo.tumati.me/api/webhooks/clerk` - it creates users in the shared database that all your apps use.

---

## Status

- [x] Webhook handler created
- [ ] Signing secret added to Vercel
- [ ] Webhook endpoint configured in Clerk
- [ ] Tested and verified

Complete these steps to enable automatic user creation!
