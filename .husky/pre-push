#!/bin/sh
# Week 2: Pre-push validation
# Runs before EVERY push - comprehensive checks
# Target: < 5 minutes

echo "ðŸš€ Pre-push: Running comprehensive validation..."

# 1. Full unit test suite with coverage (~30 sec)
echo "  â†’ Running full test suite with coverage..."
npm run test:coverage || {
  echo "âŒ Tests failed or coverage below threshold. Please fix and try again."
  exit 1
}

# 2. Build verification (~1-2 min)
echo "  â†’ Building for production..."
npm run build || {
  echo "âŒ Build failed. Please fix errors and try again."
  exit 1
}

# 3. SonarCloud code quality analysis (skip if token not set) (~15-30 sec)
if [ -n "$SONAR_TOKEN" ]; then
  echo "  â†’ Running SonarCloud analysis..."
  npm run sonar || {
    echo "âŒ SonarCloud analysis failed. Please fix code quality issues and try again."
    echo "   View details: https://sonarcloud.io/dashboard?id=tumativerse_mo-app"
    exit 1
  }
else
  echo "  âš ï¸  Skipping SonarCloud analysis (SONAR_TOKEN not set)"
  echo "     Run 'export SONAR_TOKEN=your-token' to enable SonarCloud in pre-push hook"
fi

# 4. E2E critical paths (skip if browsers not installed) (~1.5 min)
if [ -d "$HOME/Library/Caches/ms-playwright" ]; then
  echo "  â†’ Running E2E critical path tests..."
  npm run test:e2e:critical || {
    echo "âŒ E2E tests failed. Please fix and try again."
    exit 1
  }
else
  echo "  âš ï¸  Skipping E2E tests (Playwright browsers not installed)"
  echo "     Run 'npx playwright install' to enable E2E tests in pre-push hook"
fi

echo "âœ… Pre-push checks passed! Safe to push."
